name: Keep Backend Alive

on:
  schedule:
    # Runs every 10 minutes from 3:30 AM to 4:30 PM UTC (9 AM to 10 PM IST)
    # GitHub cron doesn't support :30, so we run every 10 mins and check time in script
    - cron: '*/10 * * * *'
  workflow_dispatch:  # Allow manual trigger for testing

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if within business hours (9 AM - 10 PM IST)
        id: check-time
        run: |
          # Get current hour in IST (UTC+5:30)
          CURRENT_HOUR=$(TZ='Asia/Kolkata' date +%H)
          echo "Current IST hour: $CURRENT_HOUR"
          
          # Check if between 9 AM (09) and 10 PM (22)
          if [ "$CURRENT_HOUR" -ge 9 ] && [ "$CURRENT_HOUR" -lt 22 ]; then
            echo "Within business hours - will ping backend"
            echo "should_ping=true" >> $GITHUB_OUTPUT
          else
            echo "Outside business hours - skipping"
            echo "should_ping=false" >> $GITHUB_OUTPUT
          fi

      - name: Ping Backend to Keep Alive
        if: steps.check-time.outputs.should_ping == 'true'
        run: |
          echo "üèì Pinging backend..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://jc-glasshouse-api.onrender.com/)
          
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "‚úÖ Backend is awake! Status: $HTTP_STATUS"
          else
            echo "‚ö†Ô∏è Backend responded with status: $HTTP_STATUS"
          fi

      - name: Skip Message
        if: steps.check-time.outputs.should_ping == 'false'
        run: |
          echo "üò¥ Outside business hours (9 AM - 10 PM IST). Backend is allowed to sleep."
